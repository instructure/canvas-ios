---
name: CITest
on:
  push:
    branches:
      - '*'
      - '!master'

jobs:
  citest:
    name: CITest
    runs-on: macOS-10.14
    steps:
      - uses: actions/checkout@v1
        with:
          fetch-depth: 1
      - name: Brew Install
        run: brew install bitrise
      - uses: actions/setup-node@master
        with:
          node-version: 10.16.0
      - name: Use XCode 11
        run: sudo xcode-select -s /Applications/Xcode_11.app/Contents/Developer
      - name: Bitrise Secrets
        run: |
          printf "%s" "${{ secrets.BITRISE_SECRETS_YML }}" > .bitrise.secrets.yml
      - name: Canvas iOS Secrets
        run: |
          git clone https://ios-danger:${{ secrets.DANGER_GITHUB_TOKEN }}@github.com/instructure/steps-canvas-ios-secrets ../secrets
          ../secrets/scripts/setup-dev-secrets.sh
      - name: Bitrise
        run: |
          bitrise --ci run danger --config scripts/build_automation/bitrise_workflows/tests.yml
        env:
          BITRISE_STACK_ID: osx-xcode-11.1.x
          BITRISEIO_STACK_ID: osx-xcode-11.1.x
