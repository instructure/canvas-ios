name: CITest
on:
  push:
    branches:
      - '*'
      - '!master'

jobs:
  citest:
    name: CITest
    runs-on: macOS-10.14
    steps:
      - uses: actions/checkout@v1
        with:
          fetch-depth: 1
      - name: Brew Tap
        run: brew tap thii/xcbeautify https://github.com/thii/xcbeautify.git
      - name: Brew Install
        run: brew install swiftlint xcbeautify
      - name: Use XCode 11
        run: sudo xcode-select -s /Applications/Xcode_11.app/Contents/Developer
      - name: SwiftLint
        run: ./scripts/runSwiftLint.sh
      - uses: actions/setup-node@master
        with:
          node-version: 10.16.0
      - name: YARN Install Teacher
        run: yarn
        working-directory: ./rn/Teacher
      - name: YARN Lint
        run: yarn lint
        working-directory: ./rn/Teacher
      - name: YARN Test
        run: yarn test --silent --coverage --color
        working-directory: ./rn/Teacher
      - name: Install react-native-cli
        run: yarn global add react-native-cli
      - name: Canvas iOS Secrets
        run: |
          git clone https://ios-danger:${{ secrets.DANGER_GITHUB_TOKEN }}@github.com/instructure/steps-canvas-ios-secrets ../secrets
          ../secrets/scripts/setup-dev-secrets.sh
      - name: Carthage Bootstrap
        run: carthage bootstrap --platform iOS
      - name: CocoaPods Install
        run: pod install
      - name: Run CITests
        run: |
          set -o pipefail && xcodebuild \
            -workspace Canvas.xcworkspace \
            -scheme CITests \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 8,OS=13.0' \
            -configuration Debug \
            test | xcbeautify
        env:
          NSUnbufferedIO: YES
          CODE_SIGNING_REQUIRED: NO