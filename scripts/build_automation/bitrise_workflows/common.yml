---
app:
  envs:
  - TEAM_ID: B6333T4PXQ
  - BITRISE_PROJECT_PATH: "./Canvas.xcworkspace"
  - BITRISE_CONFIGURATION: Release
  - TEST_APP_SLUG: 0dd579306f1d4289
  - RCT_NO_LAUNCH_PACKAGER: 1
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
format_version: '4'
project_type: other
workflows:

  ad-hoc:
    before_run:
    - _ad-hoc-vars
    - _set-export-ad-hoc
    - _common
    steps:
    - script:
        title: Update build link
        is_skippable: true
        inputs:
        - runner_bin: "/bin/zsh"
        - content: |-
            set -euo pipefail
            ./scripts/run-swift build-link update-link student $BITRISE_GIT_BRANCH \
                $BITRISE_PUBLIC_INSTALL_PAGE_URL

  student-app-store:
    before_run:
    - _student-vars
    - _set-export-app-store
    - _common
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            ./Pods/FirebaseCrashlytics/upload-symbols -gsp "$BITRISE_SOURCE_DIR/Student/Student/GoogleService-Info.plist" -p ios "$BITRISE_DSYM_PATH"
    - deploy-to-itunesconnect-application-loader:
        inputs:
        - password: "$APPSTORECONNECT_PASSWORD"
        - itunescon_user: iosbuilds@instructure.com

  teacher-app-store:
    before_run:
    - _teacher-vars
    - _set-export-app-store
    - _common
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            ./Pods/FirebaseCrashlytics/upload-symbols -gsp "$BITRISE_SOURCE_DIR/rn/Teacher/ios/Teacher/GoogleService-Info.plist" -p ios "$BITRISE_DSYM_PATH"
    - deploy-to-itunesconnect-application-loader:
        inputs:
        - password: "$APPSTORECONNECT_PASSWORD"
        - itunescon_user: iosbuilds@instructure.com

  parent-app-store:
    before_run:
    - _parent-vars
    - _set-export-app-store
    - _common
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            ./Pods/FirebaseCrashlytics/upload-symbols -gsp "$BITRISE_SOURCE_DIR/Parent/Parent/GoogleService-Info.plist" -p ios "$BITRISE_DSYM_PATH"
    - deploy-to-itunesconnect-application-loader:
        inputs:
        - password: "$APPSTORECONNECT_PASSWORD"
        - itunescon_user: iosbuilds@instructure.com

  student-app-store-automated:
    before_run:
    - _student-vars
    - _app-store-automated

  teacher-app-store-automated:
    before_run:
    - _teacher-vars
    - _app-store-automated

  parent-app-store-automated:
    before_run:
    - _parent-vars
    - _app-store-automated

  _common:
    steps:
    - git::git@github.com:instructure/steps-canvas-ios-secrets.git@master:
        title: Canvas iOS Secrets
    - cache-pull: {}
    - script:
        title: Install build tools
        inputs:
        - runner_bin: "/bin/zsh"
        - content: |-
            #!/bin/zsh
            set -euxo pipefail

            rm -rf "$BITRISE_SOURCE_DIR/Pods/Target Support Files/yoga"
    - yarn:
        inputs:
        - workdir: "$BITRISE_SOURCE_DIR/rn/Teacher"
        title: yarn install dependencies
    - cocoapods-install:
        inputs:
        - verbose: 'false'
    - ios-auto-provision:
        inputs:
        - generate_profiles: 'yes'
        - distribution_type: "$BITRISE_EXPORT_METHOD"
        - configuration: "$BITRISE_CONFIGURATION"
        outputs:
        - BITRISE_DEVELOPMENT_CODESIGN_IDENTITY: BITRISE_CODESIGN_IDENTITY
        - BITRISE_PRODUCTION_CODESIGN_IDENTITY: BITRISE_CODESIGN_IDENTITY
        - BITRISE_DEVELOPMENT_PROFILE: BITRISE_PROFILE
        - BITRISE_PRODUCTION_PROFILE: BITRISE_PROFILE
    - set-xcode-build-number:
        inputs:
        - plist_path: Student/Student/Info.plist
    - set-xcode-build-number:
        inputs:
        - plist_path: Student/GradesWidget/Info.plist
    - set-xcode-build-number:
        inputs:
        - plist_path: Student/SubmitAssignment/Info.plist
    - set-xcode-build-number:
        inputs:
        - plist_path: rn/Teacher/ios/Teacher/Info.plist
    - set-xcode-build-number:
        inputs:
        - plist_path: Parent/Parent/Info.plist
    - bitrise-step-stamp-appicon-with-version-number:
        run_if: '{{enveq "BITRISE_EXPORT_METHOD" "ad-hoc"}}'
        inputs:
        - stamp_path_to_icons: Student/Student/Assets.xcassets/AppIcon.appiconset
        - stamp_version: PR
        title: Stamp Student AppIcon with version number if ad-hoc
    - bitrise-step-stamp-appicon-with-version-number:
        inputs:
        - stamp_path_to_icons: rn/Teacher/ios/Teacher/Assets.xcassets/AppIcon.appiconset
        - stamp_version: PR
        run_if: '{{enveq "BITRISE_EXPORT_METHOD" "ad-hoc"}}'
        title: Stamp Teacher AppIcon with version number if ad-hoc
    - bitrise-step-stamp-appicon-with-version-number:
        run_if: '{{enveq "BITRISE_EXPORT_METHOD" "ad-hoc"}}'
        inputs:
        - stamp_path_to_icons: Parent/Parent/Assets.xcassets/AppIcon.appiconset
        - stamp_version: PR
        title: Stamp Parent AppIcon with version number if ad-hoc
    - xcode-archive:
        inputs:
        - configuration: "$BITRISE_CONFIGURATION"
        - compile_bitcode: 'no'
        - upload_bitcode: 'no'
        - export_method: "$BITRISE_EXPORT_METHOD"
        - icloud_container_environment: "Production"
    - deploy-to-bitrise-io: {}

  _app-store-automated:
    steps:
    - yarn:
        title: yarn install
    - script:
        inputs:
        - runner_bin: "/bin/zsh"
        - content: |-
            # fail if any commands fails
            # set -e
            # set -x

            scripts/build_automation/automateVersioning.sh verifyInputs
            scripts/build_automation/automateVersioning.sh checkoutReleaseBranch
            for plist in ${=INFO_PLISTS}; do
                scripts/build_automation/automateVersioning.sh updateVersionAndBuildNumberInPlist $plist
            done
            git add ${=INFO_PLISTS}
            scripts/build_automation/automateVersioning.sh checkInReleaseBranchAndTag
            scripts/build_automation/automateVersioning.sh generateReleaseNotes

        title: Branch,Tag,Trigger Release
    - trigger-bitrise-workflow:
        inputs:
        - app_slug: "$TEST_APP_SLUG"
        - api_token: "$TEST_BUILD_TRIGGER"
        - branch: "$RELEASE_BRANCH"
        - tag: ""
        - commit_hash: ""
        - commit_message: ""
        - workflow_id: nightly
        - branch_dest: ""
        - pull_request_id: ""
        - pull_request_repository_url: ""
        - pull_request_merge_branch: ""
        - pull_request_head_branch: ""
    - slack:
        inputs:
        - is_debug_mode: 'no'
        - channel: "#ios-bots"
        - text: "$RELEASE_NOTES"
        - from_username: Bob the Bitrise Bot
        - color: "#0480e5"
        - pretext: "*Releasing $APP_NAME $APP_RELEASE_VERSION*"
        - webhook_url: "$SLACK_URL"
    - deploy-to-bitrise-io: {}

    _student-vars:
    - script:
        title: Set Student environment variables
        inputs:
        - runner_bin: "/bin/zsh"
        - content: |-
            set -exo pipefail

            envman add --key BITRISE_XCARCHIVE_PATH --value ./archives/Student.xcarchive
            envman add --key BITRISE_SCHEME --value Student
            envman add --key RELEASE_BRANCH --value release/student
            envman add --key APP_NAME --value Student
            envman add --key INFO_PLISTS --value "Student/Student/Info.plist Student/GradesWidget/Info.plist Student/SubmitAssignment/Info.plist"

    _teacher-vars:
    - script:
        title: Set Teacher environment variables
        inputs:
        - runner_bin: "/bin/zsh"
        - content: |-
            set -exo pipefail

            envman add --key BITRISE_XCARCHIVE_PATH --value ./archives/Teacher.xcarchive
            envman add --key BITRISE_SCHEME --value Teacher
            envman add --key RELEASE_BRANCH --value release/teacher
            envman add --key APP_NAME --value Teacher
            envman add --key INFO_PLISTS --value rn/Teacher/ios/Teacher/Info.plist

    _parent-vars:
    - script:
        title: Set Parent environment variables
        inputs:
        - runner_bin: "/bin/zsh"
        - content: |-
            set -exo pipefail

            envman add --key BITRISE_XCARCHIVE_PATH --value ./archives/Parent.xcarchive
            envman add --key BITRISE_SCHEME --value Parent
            envman add --key RELEASE_BRANCH --value release/parent
            envman add --key APP_NAME --value Parent
            envman add --key INFO_PLISTS --value Parent/Parent/Info.plist

    _ad-hoc-vars:
    - script:
        title: Set ad-hoc environment variables
        inputs:
        - runner_bin: "/bin/zsh"
        - content: |-
            set -exo pipefail

            envman add --key BITRISE_XCARCHIVE_PATH --value ./archives/all.xcarchive
            envman add --key BITRISE_SCHEME --value All

  _set-export-ad-hoc:
    steps:
    - set-env-var:
        inputs:
        - destination_keys: BITRISE_EXPORT_METHOD
        - value: ad-hoc

  _set-export-app-store:
    steps:
    - set-env-var:
        inputs:
        - destination_keys: BITRISE_EXPORT_METHOD
        - value: app-store
